<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="1400" height="1000" viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="GlobalMed MES Data Architecture v1">
  <title>GlobalMed MES v1 Data Architecture (Version B + Expansion)</title>
  <desc>FE→BE→DB 표준 경로, ERP/HMI는 Inbox를 통해 수신, PowerBI는 DB에서 읽기. 화살표는 박스 가장자리에 스냅되고 항상 상단에 렌더.</desc>

  <!-- 스타일 -->
  <defs>
    <style type="text/css"><![CDATA[
      .title { font: 700 26px/1.3 "Segoe UI", Arial, sans-serif; fill: #13293D; }
      .subtitle { font: 500 14px/1.3 "Segoe UI", Arial, sans-serif; fill: #2F3E46; opacity:.85;}
      .cluster { fill:#F7F9FC; stroke:#C9D6DF; stroke-width:2; rx:10; }
      .legendBox { fill:#FFFFFF; stroke:#A7BBC7; stroke-width:1.5; rx:8; }
      .ext { fill:#E6FFFB; stroke:#36CFC9; stroke-width:1.5; rx:8; }
      .integ { fill:#FFFBE6; stroke:#FAAD14; stroke-width:1.5; rx:8; }
      .app { fill:#E6F7FF; stroke:#69C0FF; stroke-width:1.5; rx:8; }
      .sec { fill:#F9F0FF; stroke:#B37FEB; stroke-width:1.5; rx:8; }
      .db { fill:#F6FFED; stroke:#73D13D; stroke-width:2; rx:12; }
      .dbZone { fill:#FFFFFF; stroke:#B7EB8F; stroke-width:1.5; rx:8; }
      .dbTable { fill:#FFFFFF; stroke:#95DE64; stroke-width:1.2; rx:6; }
      .label { font: 600 13px/1.2 "Segoe UI", Arial, sans-serif; fill:#1F2D3D; }
      .labelSmall { font: 12px/1.3 "Segoe UI", Arial, sans-serif; fill:#34495E; }
      .mono { font: 11.5px/1.35 "Cascadia Mono", "Consolas", monospace; fill:#334155; }
      .arrow { stroke:#475569; stroke-width:1.8; stroke-linecap:round; fill:none; marker-end:url(#arrowhead); }
      .arrowStrong { stroke:#1D4ED8; stroke-width:2.2; stroke-linecap:round; fill:none; marker-end:url(#arrowhead); }
      .arrowOptional { stroke:#64748B; stroke-width:1.6; stroke-dasharray:6 4; stroke-linecap:round; fill:none; marker-end:url(#arrowhead); opacity:.9;}
      .note { font: 11.5px/1.3 "Segoe UI", Arial, sans-serif; fill:#6B7280; }
    ]]></style>

    <!-- 화살표 머리 -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#475569"/>
    </marker>

    <!-- 드롭 섀도우(가벼운) -->
    <filter id="shadow" x="-5%" y="-5%" width="110%" height="110%">
      <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.12"/>
    </filter>
  </defs>

  <!-- 타이틀 -->
  <g transform="translate(30,30)">
    <text class="title">GlobalMed MES Data Architecture • v1 (Version B, 확장 포함)</text>
    <text class="subtitle" y="24">MESA-11 • UTC • RESTRICT FK • JPA 친화 • code_id 일원화 • worker=TB_USER FK</text>
  </g>

  <!-- 외부 시스템 -->
  <g id="external" transform="translate(30,100)">
    <rect class="cluster" width="1340" height="120" filter="url(#shadow)"/>
    <text class="label" x="12" y="20">External Systems</text>
    <!-- ERP -->
    <g id="box_erp" transform="translate(40,35)">
      <rect class="ext" width="230" height="70"/>
      <text class="label" x="12" y="22">ERP (생산계획/주문)</text>
      <text class="labelSmall" x="12" y="44">Push/Webhook or Batch</text>
      <text class="labelSmall" x="12" y="62">예: 계획 JSON</text>
    </g>
    <!-- HMI -->
    <g id="box_hmi" transform="translate(320,35)">
      <rect class="ext" width="230" height="70"/>
      <text class="label" x="12" y="22">HMI (C#)</text>
      <text class="labelSmall" x="12" y="44">상태/텔레메트리</text>
      <text class="labelSmall" x="12" y="62">RUN/SPEED</text>
    </g>
    <!-- Power BI -->
    <g id="box_bi" transform="translate(600,35)">
      <rect class="ext" width="230" height="70"/>
      <text class="label" x="12" y="22">Power BI</text>
      <text class="labelSmall" x="12" y="44">DB 읽기(뷰/테이블)</text>
      <text class="labelSmall" x="12" y="62">DirectQuery/Import</text>
    </g>
    <!-- IdP(옵션) -->
    <g id="box_idp" transform="translate(880,35)">
      <rect class="ext" width="230" height="70"/>
      <text class="label" x="12" y="22">IdP (선택)</text>
      <text class="labelSmall" x="12" y="44">OAuth2/OpenID</text>
      <text class="labelSmall" x="12" y="62">SSO 가능</text>
    </g>
  </g>

  <!-- 앱/통합 -->
  <g id="app_integration" transform="translate(30,250)">
    <rect class="cluster" width="1340" height="260" filter="url(#shadow)"/>
    <text class="label" x="12" y="20">Application and Integration Layer</text>

    <!-- 프론트 -->
    <g id="box_fe" transform="translate(40,40)">
      <rect class="app" width="280" height="200"/>
      <text class="label" x="12" y="22">Frontend (React)</text>
      <text class="labelSmall" x="12" y="44">로그인/메뉴 권한</text>
      <text class="labelSmall" x="12" y="62">지시/상태/실적</text>
      <text class="labelSmall" x="12" y="80">KPI 카드</text>
    </g>

    <!-- 백엔드 -->
    <g id="box_be" transform="translate(360,40)">
      <rect class="app" width="300" height="200"/>
      <text class="label" x="12" y="22">Backend API (Java/JPA)</text>
      <text class="labelSmall" x="12" y="44">Auth/RBAC/Trace</text>
      <text class="labelSmall" x="12" y="62">WorkOrder/EquipStatus/Perf/KPI</text>
      <text class="labelSmall" x="12" y="80">Tx: PERF→WO 누적</text>
      <text class="labelSmall" x="12" y="98">UTC/코드 resolve</text>
    </g>

    <!-- 통합 -->
    <g id="box_integration" transform="translate(700,40)">
      <rect class="integ" width="610" height="200"/>
      <text class="label" x="12" y="22">Integration</text>

      <!-- Inbox -->
      <g id="box_inbox" transform="translate(20,40)">
        <rect class="integ" width="180" height="70"/>
        <text class="labelSmall" x="10" y="20">TB_INT_INBOX</text>
        <text class="mono" x="10" y="42">message_id PK</text>
        <text class="mono" x="10" y="60">멱등 수신</text>
      </g>

      <!-- ERP Staging -->
      <g id="box_staging" transform="translate(220,40)">
        <rect class="integ" width="200" height="70"/>
        <text class="labelSmall" x="10" y="20">TB_ERP_PROD_ORDER</text>
        <text class="mono" x="10" y="42">erp_order_no UK</text>
        <text class="mono" x="10" y="60">스테이징</text>
      </g>

      <!-- Outbox -->
      <g id="box_outbox" transform="translate(20,130)">
        <rect class="integ" width="180" height="70"/>
        <text class="labelSmall" x="10" y="20">TB_INT_OUTBOX</text>
        <text class="mono" x="10" y="42">event/published</text>
        <text class="mono" x="10" y="60">최소 한 번</text>
      </g>

      <!-- Link -->
      <g id="box_link" transform="translate(240,130)">
        <rect class="integ" width="180" height="70"/>
        <text class="labelSmall" x="10" y="20">TB_ERP_WO_LINK</text>
        <text class="mono" x="10" y="42">ERP↔WO</text>
        <text class="mono" x="10" y="60">동기화</text>
      </g>

      <!-- Telemetry -->
      <g id="box_tel" transform="translate(440,40)">
        <rect class="integ" width="150" height="160"/>
        <text class="labelSmall" x="10" y="20">TB_EQP_TELEMETRY</text>
        <text class="mono" x="10" y="42">eqp+tag+ts UK</text>
        <text class="mono" x="10" y="60">value_num/str</text>
      </g>
    </g>
  </g>

  <!-- 데이터베이스 -->
  <g id="database" transform="translate(30,540)">
    <rect class="db" width="1340" height="420" filter="url(#shadow)"/>
    <text class="label" x="12" y="24">Database (MySQL 8 • UTC • RESTRICT • JPA 친화)</text>
    <text class="note" x="12" y="44">CHECK(end≥start, defect≤produced), 인덱스(equipment_id,start_time)/(work_order_id,start_time), code_id 일원화, worker=TB_USER FK</text>

    <!-- 기준/마스터 -->
    <g id="zone_master" transform="translate(20,70)">
      <rect class="dbZone" width="300" height="150"/>
      <text class="label" x="10" y="18">기준/마스터</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="135" height="28"/><text class="mono" x="8" y="18">TB_WORKSHOP</text>
        <g transform="translate(145,0)"><rect class="dbTable" width="135" height="28"/><text class="mono" x="8" y="18">TB_WORKCENTER</text></g>
        <g transform="translate(0,36)"><rect class="dbTable" width="135" height="28"/><text class="mono" x="8" y="18">TB_PROCESS</text></g>
        <g transform="translate(145,36)"><rect class="dbTable" width="135" height="28"/><text class="mono" x="8" y="18">TB_ITEM</text></g>
        <g transform="translate(0,72)"><rect class="dbTable" width="135" height="28"/><text class="mono" x="8" y="18">TB_WAREHOUSE</text></g>
        <g transform="translate(145,72)"><rect class="dbTable" width="135" height="28"/><text class="mono" x="8" y="18">TB_EQUIPMENT</text></g>
      </g>
    </g>

    <!-- 계획/지시 -->
    <g id="zone_plan" transform="translate(340,70)">
      <rect class="dbZone" width="250" height="150"/>
      <text class="label" x="10" y="18">계획/지시</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="230" height="28"/><text class="mono" x="8" y="18">TB_PRODUCTION_PLAN</text>
        <g transform="translate(0,36)"><rect class="dbTable" width="230" height="28"/><text class="mono" x="8" y="18">TB_WORK_ORDER</text></g>
      </g>
    </g>

    <!-- 실행/상태 -->
    <g id="zone_exec" transform="translate(610,70)">
      <rect class="dbZone" width="300" height="150"/>
      <text class="label" x="10" y="18">실행/상태</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="270" height="28"/><text class="mono" x="8" y="18">TB_PRODUCTION_PERFORMANCE</text>
        <g transform="translate(0,36)"><rect class="dbTable" width="270" height="28"/><text class="mono" x="8" y="18">TB_EQUIPMENT_STATUS_LOG</text></g>
      </g>
    </g>

    <!-- 교대/배치 -->
    <g id="zone_shift" transform="translate(930,70)">
      <rect class="dbZone" width="190" height="150"/>
      <text class="label" x="10" y="18">교대/배치</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="170" height="28"/><text class="mono" x="8" y="18">TB_SHIFT</text>
        <g transform="translate(0,36)"><rect class="dbTable" width="170" height="28"/><text class="mono" x="8" y="18">TB_SHIFT_CALENDAR</text></g>
        <g transform="translate(0,72)"><rect class="dbTable" width="170" height="28"/><text class="mono" x="8" y="18">TB_SHIFT_ASSIGNMENT</text></g>
      </g>
    </g>

    <!-- 품질 -->
    <g id="zone_quality" transform="translate(20,240)">
      <rect class="dbZone" width="300" height="150"/>
      <text class="label" x="10" y="18">품질(라이트)</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="270" height="28"/><text class="mono" x="8" y="18">TB_INSPECTION</text>
        <g transform="translate(0,36)"><rect class="dbTable" width="270" height="28"/><text class="mono" x="8" y="18">TB_INSPECTION_RESULT</text></g>
        <g transform="translate(0,72)"><rect class="dbTable" width="270" height="28"/><text class="mono" x="8" y="18">TB_DEFECT</text></g>
        <g transform="translate(0,108)"><rect class="dbTable" width="270" height="28"/><text class="mono" x="8" y="18">TB_NON_CONFORMANCE</text></g>
      </g>
    </g>

    <!-- KPI/감사 -->
    <g id="zone_kpi" transform="translate(340,240)">
      <rect class="dbZone" width="250" height="150"/>
      <text class="label" x="10" y="18">KPI/감사</text>
      <g transform="translate(10,30)">
        <rect id="box_kpi" class="dbTable" width="230" height="28"/><text class="mono" x="8" y="18">TB_KPI_TARGET</text>
        <g transform="translate(0,36)"><rect class="dbTable" width="230" height="28"/><text class="mono" x="8" y="18">TB_AUDIT_LOG</text></g>
      </g>
    </g>

    <!-- 보안/RBAC -->
    <g id="zone_sec" transform="translate(610,240)">
      <rect class="dbZone sec" width="300" height="150"/>
      <text class="label" x="10" y="18">보안/RBAC</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="130" height="28"/><text class="mono" x="8" y="18">TB_USER</text>
        <g transform="translate(140,0)"><rect class="dbTable" width="150" height="28"/><text class="mono" x="8" y="18">TB_ROLE</text></g>
        <g transform="translate(0,36)"><rect class="dbTable" width="130" height="28"/><text class="mono" x="8" y="18">TB_USER_ROLE</text></g>
        <g transform="translate(140,36)"><rect class="dbTable" width="150" height="28"/><text class="mono" x="8" y="18">TB_MENU</text></g>
        <g transform="translate(0,72)"><rect class="dbTable" width="290" height="28"/><text class="mono" x="8" y="18">TB_ROLE_MENU</text></g>
      </g>
    </g>

    <!-- 코드 일원화 -->
    <g id="zone_code" transform="translate(930,240)">
      <rect class="dbZone" width="190" height="150"/>
      <text class="label" x="10" y="18">코드 일원화</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="170" height="28"/><text class="mono" x="8" y="18">TB_CODE_GROUP</text>
        <g transform="translate(0,36)"><rect class="dbTable" width="170" height="28"/><text class="mono" x="8" y="18">TB_CODE</text></g>
      </g>
    </g>

    <!-- 통합(DB 측) -->
    <g id="zone_intdb" transform="translate(1140,240)">
      <rect class="dbZone" width="210" height="150"/>
      <text class="label" x="10" y="18">통합(DB 측)</text>
      <g transform="translate(10,30)">
        <rect class="dbTable" width="190" height="24"/><text class="mono" x="8" y="16">TB_INT_INBOX</text>
        <g transform="translate(0,30)"><rect class="dbTable" width="190" height="24"/><text class="mono" x="8" y="16">TB_ERP_PROD_ORDER</text></g>
        <g transform="translate(0,60)"><rect class="dbTable" width="190" height="24"/><text class="mono" x="8" y="16">TB_INT_OUTBOX</text></g>
        <g transform="translate(0,90)"><rect class="dbTable" width="190" height="24"/><text class="mono" x="8" y="16">TB_ERP_WO_LINK</text></g>
      </g>
    </g>
  </g>

  <!-- 범례 -->
  <g id="legend" transform="translate(1080,30)">
    <rect class="legendBox" width="290" height="140" filter="url(#shadow)"/>
    <text class="label" x="12" y="20">Legend</text>
    <g transform="translate(12,30)">
      <rect width="16" height="12" class="ext"/><text class="labelSmall" x="24" y="12">External</text>
      <g transform="translate(0,20)"><rect width="16" height="12" class="integ"/><text class="labelSmall" x="24" y="12">Integration</text></g>
      <g transform="translate(0,40)"><rect width="16" height="12" class="app"/><text class="labelSmall" x="24" y="12">Application</text></g>
      <g transform="translate(0,60)"><rect width="16" height="12" class="db"/><text class="labelSmall" x="24" y="12">Database</text></g>
      <g transform="translate(0,80)"><line x1="0" y1="6" x2="18" y2="6" class="arrow"/><text class="labelSmall" x="24" y="10">Data Flow</text></g>
    </g>
  </g>

  <!-- 커넥터: 항상 마지막(최상단) -->
  <g id="connectors">
    <!-- FE → BE -->
    <path class="arrowStrong" d="M 320 390 L 360 390"/>
    <!-- BE → DB(세로 스냅: BE 하단 → DB 상단) -->
    <path class="arrowStrong" d="M 510 450 L 510 540"/>
    <!-- Integration → DB (중앙 세로 연결) -->
    <path class="arrowStrong" d="M 1000 450 L 1000 540"/>

    <!-- ERP → Inbox (박스 하단센터 → Integration 상단 라인 → Inbox 상단변) -->
    <!-- ERP box abs: (x=70,y=135,w=230,h=70) -->
    <path class="arrow" d="M 185 205 L 185 290 L 760 290 L 760 330"/>

    <!-- HMI → Inbox -->
    <!-- HMI box abs: (x=350,y=135,w=230,h=70) -->
    <path class="arrow" d="M 465 205 L 465 290 L 760 290 L 760 330"/>

    <!-- DB(KPI) → PowerBI (읽기 전용) -->
    <!-- KPI zone abs top: x≈370.., y=780; PowerBI box abs bottom: x center=745, y=205 -->
    <path class="arrow" d="M 495 780 L 495 720 L 745 720 L 745 205"/>

    <!-- IdP(옵션) → Backend (점선) -->
    <!-- IdP box abs: (x=910,y=135,w=230,h=70). Backend left: x=390,y=290 -->
    <path class="arrowOptional" d="M 1025 205 L 1025 260 L 510 260 L 510 290"/>
  </g>

  <!-- 주석 -->
  <text class="note" x="30" y="980">Note: FE는 DB에 직접 접근하지 않음. 모든 외부 연동은 Inbox/Outbox를 통해 수신/발행. BI는 DB에서 읽기 전용.</text>
</svg>